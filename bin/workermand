#!/usr/bin/env php
<?php
define('WORKERMAND_ROOT', dirname(dirname(__FILE__)));

$loader = require WORKERMAND_ROOT . '/vendor/autoload.php';
use Workerman\Worker;

define('WORKERMAND_VER', 'workermand/0.0.1 (workerman/' . Worker::VERSION . ')');

$ret = w8d_main();
exit($ret);

function w8d_main()
{
    $opt_show_ver = false;
    $opt_show_help = false;
    $opt_signal = null;
    $opt_daemon = false;
    $conf_file = WORKERMAND_ROOT . '/etc/workermand.json';

    $options = getopt("hvds:c:");
    foreach ($options as $opt => $v) {

        switch ($opt) {
            case 'v':
                $opt_show_ver = true; continue;

            case 'h':
                $opt_show_ver = true;
                $opt_show_help = true;
                continue;

            case 'd':
                $opt_daemon = true;
                continue;

            case 's':
                $opt_signal = $v;
                continue;

            case 'c':
                $conf_file = $v;
                continue;
        }
    }

    if ($opt_show_ver) {
        w8d_write_stderr('workermand version: ' . WORKERMAND_VER);

        if ($opt_show_help) {
            w8d_write_stderr(
                "Usage: workermand [-hv] [-s signal] [-c filename]" . PHP_EOL . PHP_EOL.
                "Options:" .PHP_EOL.
                "  -h         : this help" .PHP_EOL.
                "  -v            : show version and exit" .PHP_EOL.
                "  -t            : test configuration and exit" .PHP_EOL.
                "  -d            : daemon" .PHP_EOL.
                "  -s signal     : send signal to a master process: ".
                                   "stop, quit, reopen, reload" .PHP_EOL.
                "  -c filename   : set configuration file (default: )".PHP_EOL
            );
        }
        return 0;
    }

    $conf = w8d_init_conf($conf_file);

    if ($opt_signal) {
        return w8d_kill($opt_signal);
    }

    global $loader;
    $loader->setPsr4('Workermand\\', WORKERMAND_ROOT . '/lib');

    w8d_init_thrift_worker($conf);

    if ($opt_daemon) {
        w8d_exec('workermand', 'start', '-d');
    } else {
        w8d_exec('workermand', 'start');
    }
}

function w8d_write_stderr($str)
{
    file_put_contents('php://stderr', $str . PHP_EOL);
}

function w8d_exec()
{
    global $argv, $argc;

    $argv = func_get_args();
    $argc = count($argv);
    Worker::runAll();
}

function w8d_init_conf($conf_file)
{
    if (!file_exists($conf_file)) {
        w8d_write_stderr('conf file not exists:' . $conf_file);
        exit(1);
    }
    $conf = json_decode(file_get_contents($conf_file), true);
    if ($conf === NULL) {
        w8d_write_stderr($conf_file . ' does not contain valid JSON');
        exit(1);
    }

    if (array_key_exists('pid', $conf)) {
        Worker::$pidFile = $conf['pid'];
    }
    if (array_key_exists('log', $conf)) {
        Worker::$logFile = $conf['log'];
    }
    return $conf;
}

function w8d_kill($signal)
{
    switch ($signal) {
        case 'stop':
        case 'reload':
        case 'restart':
        case 'status':
            w8d_exec('workermand', $signal);
            break;

        default:
            w8d_write_stderr('invalid signal:' . $signal . PHP_EOL);
            return 1;
    }
    return 0;
}

function w8d_init_thrift_worker($conf)
{
    foreach ($conf['thrift'] as $app) {
        $worker = new \Workermand\Thrift\ThriftWorker($app['listen'], null, $app);
        $worker->count = $app['worker_processes'];
        $worker->name = $app['ns'];
        $worker->user = $conf['user'];
    }
}
